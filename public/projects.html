<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <title>Projects</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: #0b0f2a;
      color: #ccc;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    body.light { background: #f0f2f5; color: #111; }

    .header-controls {
      width:100%;
      display:flex;
      justify-content:flex-start;
      gap:0.5rem;
      padding:1rem 2rem;
      position:sticky;
      top:0;
      backdrop-filter:blur(8px);
      background:rgba(0,0,0,0.3);
      z-index:10;
    }
    body.light .header-controls { background: rgba(255,255,255,0.3); }

    .header-controls button {
      padding:0.5rem 0.8rem;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
      transition: all 0.25s ease;
      background: #736bff;
      color: white;
    }
    .header-controls button:hover { transform: translateY(-2px); opacity:0.9; }

    .projects-container {
      width: 95%;
      max-width: 1200px;
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .domain-section {
      background: rgba(255,255,255,0.05);
      padding: 1rem;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.25s ease;
    }
    body.light .domain-section {
      background:#fff; color:#111; box-shadow:0 4px 15px rgba(0,0,0,0.1);
    }

    .domain-header {
      font-weight:700;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:1.1rem;
    }

    .domain-projects { margin-top:0.8rem; display:flex; flex-direction:column; gap:0.8rem; }

    .project-card {
      padding: 0.8rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      display:flex;
      flex-direction: column;
      gap:0.4rem;
      transition: all 0.25s ease;
      position: relative;
    }
    body.light .project-card {
      background:#fefefe; color:#111;
      box-shadow:0 4px 15px rgba(0,0,0,0.1);
    }

    .project-details { display:flex; justify-content:space-between; flex-wrap:wrap; font-size:0.95rem; }

    .project-actions { display:flex; gap:0.5rem; margin-top:0.4rem; }

    .project-actions button {
      padding:0.3rem 0.6rem; border-radius:8px; border:none; background: #736bff; color:white; cursor:pointer; font-size:0.85rem;
      transition:all 0.2s;
    }
    .project-actions button:hover { background:#927dff; }

    .delete-btn {
      position:absolute;
      top:8px;
      right:8px;
      background:red;
      color:white;
      border:none;
      border-radius:50%;
      width:20px;
      height:20px;
      font-size:14px;
      cursor:pointer;
      line-height:18px;
      text-align:center;
      opacity:0.7;
      transition:opacity 0.2s;
    }
    .delete-btn:hover { opacity:1; }

    .modal { position:fixed; inset:0; display:grid; place-items:center; background: rgba(2,6,23,0.75); z-index:1000; }
    .modal-card {
      background: linear-gradient(180deg,#071529,#071026);
      padding:1.2rem;
      border-radius:12px;
      width:400px;
      display:flex; flex-direction:column; gap:0.6rem;
      animation: fadeIn 0.25s ease;
    }
    .modal-card label { font-size:0.85rem; color: var(--muted,#aaa); margin-top:0.4rem; }
    .modal-card input, .modal-card select { padding:0.5rem; border-radius:8px; border:none; background:#000; color:#fff; border:1px solid rgba(255,255,255,0.1); width:100%; }
    .modal-actions { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem; }
    .checkbox-row { display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem; }
    .warning { color:red; font-size:0.85rem; margin-top:0.2rem; }

    .hidden { display:none; }
    @keyframes fadeIn { from{opacity:0;transform:scale(0.95);} to{opacity:1;transform:scale(1);} }

    @media(max-width:600px){
      .modal-card { width: 90%; }
      .project-details { flex-direction: column; gap: 0.3rem; }
    }
  </style>
</head>
<body>
  <div class="header-controls">
    <button onclick="window.location.href='../index.html'">‚Üê Back</button>
    <button id="toggle-theme">Day/Night</button>
    <button id="add-project">Ôºã Add Project</button>
  </div>

  <h2 style="text-align:center; margin-top:1rem;">OUR PROJECTS</h2>
  <div class="projects-container" id="projects-container"></div>

  <!-- Modal -->
  <div id="modal" class="modal hidden">
    <div class="modal-card">
      <h3 id="modal-title">Add Project</h3>
      <label>Project Name</label>
      <input id="project-name" placeholder="e.g. AI Chatbot" />
      <label>Domain</label>
      <select id="project-domain"><option value="">Loading...</option></select>
      <label>Industry</label>
      <select id="project-industry"><option value="">Select Industry</option></select>
      <label>Start Date</label>
      <input type="date" id="start-date" max="">
      <label>End Date</label>
      <input type="date" id="end-date" max="">
      <div class="warning hidden" id="date-warning">Invalid dates!</div>
      <div class="checkbox-row">
        <input type="checkbox" id="is-running" />
        <label for="is-running">running</label>
      </div>
      <div class="modal-actions">
        <button id="save-project" class="btn">Save</button>
        <button id="cancel" class="btn outline">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let projects = JSON.parse(localStorage.getItem('projects')) || [];
    let domainsData = [];

    const container = document.getElementById('projects-container');
    const modal = document.getElementById('modal');
    const projectName = document.getElementById('project-name');
    const projectDomain = document.getElementById('project-domain');
    const projectIndustry = document.getElementById('project-industry');
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    const modalTitle = document.getElementById('modal-title');
    const isRunning = document.getElementById('is-running');
    const dateWarning = document.getElementById('date-warning');
    let editIndex = null;

    const today = new Date().toISOString().split('T')[0];
    startDate.setAttribute('max', today);
    endDate.setAttribute('max', today);

    async function loadDomains(){
      try {
        const res = await fetch('https://hearachy-system.onrender.com/api/domains');
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error('Invalid domains data');
        domainsData = data;
        populateDomainDropdown();
      } catch(err) {
        console.error("Error loading domains:", err);
        alert("Failed to load domains");
      }
    }

    function populateDomainDropdown() {
      projectDomain.innerHTML = '<option value="">Select Domain</option>';
      domainsData.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.name;
        opt.textContent = d.name;
        projectDomain.appendChild(opt);
      });
    }

    projectDomain.addEventListener('change', e => {
      const selectedDomain = domainsData.find(d => d.name === e.target.value);
      projectIndustry.innerHTML = '<option value="">Select Industry</option>';
      if(selectedDomain && Array.isArray(selectedDomain.industries)){
        selectedDomain.industries.forEach(ind => {
          const opt = document.createElement('option');
          opt.value = ind.name;
          opt.textContent = ind.name;
          projectIndustry.appendChild(opt);
        });
      }
    });

    function validateDates(start, end, running) {
      if(start > today) return false;
      if(!running && !end) return false;
      if(end && end > today) return false;
      if(end && start > end) return false;
      return true;
    }

    function saveToLocalStorage() {
      localStorage.setItem('projects', JSON.stringify(projects));
    }

    function renderProjects() {
      container.innerHTML = '';
      const domains = [...new Set(projects.map(p => p.domain))];
      domains.forEach(d => {
        const section = document.createElement('div');
        section.className = 'domain-section';

        const header = document.createElement('div');
        header.className = 'domain-header';
        header.textContent = d;
        const toggleBtn = document.createElement('span');
        toggleBtn.textContent = '‚ñº';
        toggleBtn.style.cursor = 'pointer';
        header.appendChild(toggleBtn);
        section.appendChild(header);

        const projDiv = document.createElement('div');
        projDiv.className = 'domain-projects';
        projects.filter(p => p.domain === d).forEach((p, idx) => {
          const card = document.createElement('div');
          card.className = 'project-card';
          const status = p.running ? '<span style="color:lime;">üü¢ Running</span>' : '<span style="color:red;">üî¥ Completed</span>';
          card.innerHTML = `
            <h3>${p.name}</h3>
            <div class="project-details">
              <span><strong>Industry:</strong> ${p.industry}</span>
              <span><strong>Timeline:</strong> ${p.start} ‚Üí ${p.end || "Ongoing"}</span>
              <span><strong>Status:</strong> ${status}</span>
            </div>`;

          const actions = document.createElement('div');
          actions.className = 'project-actions';
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.onclick = () => openModal('edit', projects.indexOf(p));
          actions.appendChild(editBtn);
          card.appendChild(actions);

          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.textContent = '√ó';
          delBtn.onclick = () => {
            if(confirm('Delete this project?')){
              projects.splice(projects.indexOf(p), 1);
              saveToLocalStorage();
              renderProjects();
            }
          };
          card.appendChild(delBtn);

          projDiv.appendChild(card);
        });

        header.onclick = () => {
          projDiv.classList.toggle('hidden');
          toggleBtn.textContent = projDiv.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
        };

        section.appendChild(projDiv);
        container.appendChild(section);
      });
    }

    function openModal(mode, index = null) {
      modal.classList.remove('hidden');
      dateWarning.classList.add('hidden');
      if(mode === 'add'){
        modalTitle.textContent = 'Add Project';
        projectName.value = '';
        projectDomain.value = '';
        projectIndustry.innerHTML = '<option value="">Select Industry</option>';
        startDate.value = '';
        endDate.value = '';
        isRunning.checked = false;
        editIndex = null;
      } else if(mode === 'edit'){
        modalTitle.textContent = 'Edit Project';
        const p = projects[index];
        projectName.value = p.name;
        projectDomain.value = p.domain;
        projectDomain.dispatchEvent(new Event('change'));
        projectIndustry.value = p.industry;
        startDate.value = p.start;
        endDate.value = p.end || '';
        isRunning.checked = p.running;
        editIndex = index;
      }
    }

    function closeModal() { modal.classList.add('hidden'); editIndex = null; }

    document.getElementById('add-project').addEventListener('click', () => openModal('add'));
    document.getElementById('cancel').addEventListener('click', closeModal);

    document.getElementById('save-project').addEventListener('click', () => {
      const name = projectName.value.trim();
      const domain = projectDomain.value;
      const industry = projectIndustry.value;
      const start = startDate.value;
      const end = isRunning.checked ? null : endDate.value;
      const running = isRunning.checked;

      if(!name || !domain || !industry || !start || (!running && !end)){
        return alert('Please fill all fields');
      }

      if(!validateDates(start, end, running)){
        return alert('Invalid dates! Start ‚â§ End & cannot be future dates.');
      }

      const projectData = { name, domain, industry, start, end, running };
      if(editIndex !== null){ projects[editIndex] = projectData; }
      else{ projects.push(projectData); }

      saveToLocalStorage();
      renderProjects();
      closeModal();
    });

    document.getElementById('toggle-theme').addEventListener('click', () => document.body.classList.toggle('light'));

    // Initialize
    loadDomains();
    renderProjects();
  </script>
</body>
</html>
