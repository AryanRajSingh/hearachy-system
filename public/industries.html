<!DOCTYPE html>
<html lang="en">
<head>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Industries Manager</title>
<link rel="stylesheet" href="styles.css">
<style>
  :root {
    --bg: #0f1724;
    --card: #0b1220;
    --muted: #e6eef8;
    --accent: #7c5cff;
    --hover: rgba(124, 92, 255, 0.15);
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: var(--bg);
    color: var(--muted);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    margin: 0;
    transition: background 0.3s, color 0.3s;
  }
  body.light { background:#f0f2f5; color:#111; }

  .header-controls {
    width: 100%;
    display: flex;
    justify-content: flex-start;
    gap: 0.5rem;
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    backdrop-filter: blur(8px);
    background: rgba(0,0,0,0.3);
    z-index: 10;
  }
  body.light .header-controls { background: rgba(255,255,255,0.3); }

  .header-controls button {
    padding: 0.5rem 1rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: var(--accent);
    color: white;
    transition: all 0.25s ease;
  }
  .header-controls button:hover { transform: translateY(-2px); background: #927dff; }
  body.light .header-controls button { background: #7c5cff; color: #fff; }

  h1, h2 { text-align: center; margin-top: 1.5rem; }
  h2 { margin-bottom: 1rem; font-weight: 600; color: var(--accent); }

  #domains-container {
    width: 95%;
    max-width: 1200px;
    margin: 2rem auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .domain-group {
    background: var(--card);
    padding: 1rem 1.5rem;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  }
  body.light .domain-group { background: #fff; color: #111; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

  .domain-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
  }

  .domain-title {
    font-size: 1.3rem;
    font-weight: 700;
  }

  .domain-actions button {
    font-size: 0.85rem;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-left: 0.3rem;
    background: rgba(124,92,255,0.3);
    color: white;
    transition: all 0.25s ease;
  }
  .domain-actions button:hover { background: var(--accent); }

  .industry-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
    gap: 1rem;
    margin-top: 0.5rem;
  }

  .industry-card {
    width: fit-content;
    padding: 0.8rem;
    border-radius: 12px;
    background: rgba(255,255,255,0.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    text-align: center;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.25s ease;
  }
  .industry-card:hover { transform: translateY(-2px) scale(1.02); background: var(--hover); }
  body.light .industry-card { background: #f7f7f7; color: #111; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

  .industry-card button {
    margin-left: 0.5rem;
    background: rgba(124,92,255,0.3);
    border: none;
    border-radius: 6px;
    padding: 0.2rem 0.4rem;
    cursor: pointer;
    color: white;
    font-size: 0.8rem;
  }
  .industry-card button:hover { background: var(--accent); }

  /* Modal */
  .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(2,6,23,0.75); z-index: 1000; }
  .modal-card {
    background: linear-gradient(180deg, #071529, #071026);
    padding: 1.2rem; border-radius: 12px; width: 360px; box-shadow: 0 20px 50px rgba(2,6,23,0.8);
    animation: fadeIn 0.3s ease;
    color: #aefb2a;
  }
  .modal-card label { display: block; font-size: 0.85rem; color: var(--muted); margin-top: 0.6rem; }
  .modal-card input, .modal-card select { width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: inherit; }
  .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.8rem; }
  .modal-actions button { padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer; border: none; background: var(--accent); color: white; font-weight: 600; }
  .modal-actions button:hover { background: #927dff; }
  .hidden { display: none; }
  @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>
</head>
<body>
<div class="header-controls">
  <button onclick="window.location.href='../index.html'">‚Üê Back</button>
  <button id="theme-toggle">üåô</button>
  <button id="add-domain">Ôºã Add Domain</button>
</div>

<h1>Industries Manager</h1>
<h2>NG Grouped by Domains</h2>

<div id="domains-container"></div>

<!-- Modal -->
<div id="modal" class="modal hidden">
  <div class="modal-card">
    <h3 id="modal-title">Add Domain/Industry</h3>
    <label for="name-input">Name</label>
    <input id="name-input" placeholder="Domain or Industry Name" />
    <label for="parent-select" id="parent-label">Parent Domain</label>
    <select id="parent-select"></select>
    <div class="modal-actions">
      <button id="save-btn">Save</button>
      <button id="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<script>
const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
if (!loggedInUser) window.location.href = 'auth.html';

const isAdmin = loggedInUser.role === 'admin';
let domainsData = [];

const domainsContainer = document.getElementById('domains-container');
const modal = document.getElementById('modal');
const nameInput = document.getElementById('name-input');
const parentSelect = document.getElementById('parent-select');
const parentLabel = document.getElementById('parent-label');

let modalMode = null;
let editTarget = null;

// ---------------- LOAD DOMAINS ----------------
async function loadDomains() {
  try {
    const headers = {};
    if (loggedInUser?.token) {
      headers.Authorization = 'Bearer ' + loggedInUser.token;
    }

    const res = await fetch(
      'https://hearachy-system.onrender.com/api/domains',
      { headers }
    );

    if (!res.ok) {
      const text = await res.text();
      console.error("API Error:", text);
      throw new Error("Failed API");
    }

    const data = await res.json();

    if (!Array.isArray(data)) {
      console.error("Invalid response:", data);
      throw new Error("Invalid data");
    }

    // ‚úÖ FIXED MAPPING
    domainsData = data.map(d => ({
      id: d.id,
      name: d.name,
      industriesData: Array.isArray(d.industries) ? d.industries : []
    }));

    render();

  } catch (err) {
    console.error(err);
    alert('Failed to load domains');
  }
}

// ---------------- RENDER ----------------
function render() {
  domainsContainer.innerHTML = '';

  domainsData.forEach(domain => {
    const domainDiv = document.createElement('div');
    domainDiv.className = 'domain-group';

    const headerDiv = document.createElement('div');
    headerDiv.className = 'domain-header';

    const title = document.createElement('div');
    title.className = 'domain-title';
    title.textContent = domain.name;

    headerDiv.appendChild(title);

    if (isAdmin) {
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'domain-actions';

      const addBtn = document.createElement('button');
      addBtn.textContent = 'Ôºã Industry';
      addBtn.onclick = () => openModal('industry', domain);

      const editBtn = document.createElement('button');
      editBtn.textContent = '‚úé';
      editBtn.onclick = () => openModal('edit', domain);

      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóë';
      delBtn.onclick = () => confirm('Delete domain?') && deleteDomain(domain);

      actionsDiv.append(addBtn, editBtn, delBtn);
      headerDiv.appendChild(actionsDiv);
    }

    domainDiv.appendChild(headerDiv);

    const grid = document.createElement('div');
    grid.className = 'industry-grid';

    domain.industriesData.forEach(ind => {
      const card = document.createElement('div');
      card.className = 'industry-card';

      const span = document.createElement('span');
      span.textContent = ind.name;
      card.appendChild(span);

      if (isAdmin) {
        const e = document.createElement('button');
        e.textContent = '‚úé';
        e.onclick = () => openModal('edit', domain, ind);

        const d = document.createElement('button');
        d.textContent = 'üóë';
        d.onclick = () => confirm('Delete industry?') && deleteIndustry(ind);

        card.append(e, d);
      }

      grid.appendChild(card);
    });

    domainDiv.appendChild(grid);
    domainsContainer.appendChild(domainDiv);
  });

  document.getElementById('add-domain').style.display = isAdmin ? 'inline-block' : 'none';
}

// ---------------- MODAL ----------------
function openModal(mode, domain = null, industry = null) {
  modal.classList.remove('hidden');
  nameInput.value = '';
  parentSelect.innerHTML = '';
  modalMode = mode;
  editTarget = { domain, industry };

  if (mode === 'domain') {
    parentLabel.style.display = 'none';
  } else {
    parentLabel.style.display = 'block';
    domainsData.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.name;
      if (domain && d.id === domain.id) opt.selected = true;
      parentSelect.appendChild(opt);
    });
  }

  if (industry) nameInput.value = industry.name;
  if (domain && !industry && mode === 'edit') nameInput.value = domain.name;
}

document.getElementById('cancel-btn').onclick = () => modal.classList.add('hidden');

// ---------------- SAVE ----------------
document.getElementById('save-btn').onclick = async () => {
  const name = nameInput.value.trim();
  if (!name) return alert('Enter name');

  const headers = {
    'Content-Type': 'application/json',
    Authorization: 'Bearer ' + loggedInUser.token
  };

  try {
    if (modalMode === 'domain') {
      await fetch('https://hearachy-system.onrender.com/api/domains', {
        method: 'POST',
        headers,
        body: JSON.stringify({ name })
      });
    } else {
      const domainId = parentSelect.value;
      await fetch(
        `https://hearachy-system.onrender.com/api/domains/${domainId}/industries`,
        { method: 'POST', headers, body: JSON.stringify({ name }) }
      );
    }

    modal.classList.add('hidden');
    loadDomains();
  } catch (e) {
    alert('Save failed');
  }
};

// ---------------- DELETE ----------------
async function deleteDomain(domain) {
  await fetch(
    `https://hearachy-system.onrender.com/api/domains/${domain.id}`,
    { method: 'DELETE', headers: { Authorization: 'Bearer ' + loggedInUser.token } }
  );
  loadDomains();
}

async function deleteIndustry(ind) {
  await fetch(
    `https://hearachy-system.onrender.com/api/industries/${ind.id}`,
    { method: 'DELETE', headers: { Authorization: 'Bearer ' + loggedInUser.token } }
  );
  loadDomains();
}

// ---------------- THEME ----------------
document.getElementById('theme-toggle').onclick = () => {
  document.body.classList.toggle('light');
};

document.getElementById('add-domain').onclick = () => openModal('domain');

loadDomains();
</script>

</body>
</html>
