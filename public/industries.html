<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Industries Manager</title>
<link rel="stylesheet" href="styles.css">
<style>
  :root {
    --bg: #0f1724;
    --card: #0b1220;
    --muted: #e6eef8;
    --accent: #7c5cff;
    --hover: rgba(124, 92, 255, 0.15);
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: var(--bg);
    color: var(--muted);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    margin: 0;
    transition: background 0.3s, color 0.3s;
  }
  body.light { background:#f0f2f5; color:#111; }

  .header-controls {
    width: 100%;
    display: flex;
    justify-content: flex-start;
    gap: 0.5rem;
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    backdrop-filter: blur(8px);
    background: rgba(0,0,0,0.3);
    z-index: 10;
  }
  body.light .header-controls { background: rgba(255,255,255,0.3); }

  .header-controls button {
    padding: 0.5rem 1rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: var(--accent);
    color: white;
    transition: all 0.25s ease;
  }
  .header-controls button:hover { transform: translateY(-2px); background: #927dff; }
  body.light .header-controls button { background: #7c5cff; color: #fff; }

  h1, h2 { text-align: center; margin-top: 1.5rem; }
  h2 { margin-bottom: 1rem; font-weight: 600; color: var(--accent); }

  #domains-container {
    width: 95%;
    max-width: 1200px;
    margin: 2rem auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .domain-group {
    background: var(--card);
    padding: 1rem 1.5rem;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  }
  body.light .domain-group { background: #fff; color: #111; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

  .domain-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
  }

  .domain-title {
    font-size: 1.3rem;
    font-weight: 700;
  }

  .domain-actions button {
    font-size: 0.85rem;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-left: 0.3rem;
    background: rgba(124,92,255,0.3);
    color: white;
    transition: all 0.25s ease;
  }
  .domain-actions button:hover { background: var(--accent); }

  .industry-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
    gap: 1rem;
    margin-top: 0.5rem;
  }

  .industry-card {
    width: fit-content;
    padding: 0.8rem;
    border-radius: 12px;
    background: rgba(255,255,255,0.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    text-align: center;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.25s ease;
  }
  .industry-card:hover { transform: translateY(-2px) scale(1.02); background: var(--hover); }
  body.light .industry-card { background: #f7f7f7; color: #111; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

  .industry-card button {
    margin-left: 0.5rem;
    background: rgba(124,92,255,0.3);
    border: none;
    border-radius: 6px;
    padding: 0.2rem 0.4rem;
    cursor: pointer;
    color: white;
    font-size: 0.8rem;
  }
  .industry-card button:hover { background: var(--accent); }

  /* Modal */
  .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(2,6,23,0.75); z-index: 1000; }
  .modal-card {
    background: linear-gradient(180deg, #071529, #071026);
    padding: 1.2rem; border-radius: 12px; width: 360px; box-shadow: 0 20px 50px rgba(2,6,23,0.8);
    animation: fadeIn 0.3s ease;
    color: #aefb2a;
  }
  .modal-card label { display: block; font-size: 0.85rem; color: var(--muted); margin-top: 0.6rem; }
  .modal-card input, .modal-card select { width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: inherit; }
  .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.8rem; }
  .modal-actions button { padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer; border: none; background: var(--accent); color: white; font-weight: 600; }
  .modal-actions button:hover { background: #927dff; }
  .hidden { display: none; }
  @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>
</head>
<body>
<div class="header-controls">
  <button onclick="window.location.href='../index.html'">‚Üê Back</button>
  <button id="theme-toggle">üåô</button>
  <button id="add-domain">Ôºã Add Domain</button>
</div>

<h1>Industries Manager</h1>
<h2>NG Grouped by Domains</h2>

<div id="domains-container"></div>

<!-- Modal -->
<div id="modal" class="modal hidden">
  <div class="modal-card">
    <h3 id="modal-title">Add Domain/Industry</h3>
    <label for="name-input">Name</label>
    <input id="name-input" placeholder="Domain or Industry Name" />
    <label for="parent-select" id="parent-label">Parent Domain</label>
    <select id="parent-select"></select>
    <div class="modal-actions">
      <button id="save-btn">Save</button>
      <button id="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<script>
const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
if(!loggedInUser) window.location.href='auth.html';
const isAdmin = loggedInUser.role === 'admin';
let domainsData = [];

const domainsContainer = document.getElementById('domains-container');
const modal = document.getElementById('modal');
const nameInput = document.getElementById('name-input');
const parentSelect = document.getElementById('parent-select');
const parentLabel = document.getElementById('parent-label');
let modalMode = null;
let editTarget = null;

// Load domains and industries
async function loadDomains(){
  try{
    const res = await fetch('http://localhost:5000/api/domains', {
      headers: {'Authorization':'Bearer '+loggedInUser.token}
    });
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error('Invalid data');
    domainsData = data.map(d=>({
      id:d.id,
      name:d.name,
      industriesData:d.industries || []
    }));
    render();
  }catch(err){ console.error(err); alert('Failed to load domains'); }
}

function render(){
  domainsContainer.innerHTML='';
  domainsData.forEach(domain=>{
    const domainDiv=document.createElement('div');
    domainDiv.className='domain-group';

    const headerDiv=document.createElement('div'); headerDiv.className='domain-header';
    const title=document.createElement('div'); title.className='domain-title'; title.textContent=domain.name;
    headerDiv.appendChild(title);

    if(isAdmin){
      const actionsDiv=document.createElement('div'); actionsDiv.className='domain-actions';

      const addIndBtn=document.createElement('button'); addIndBtn.textContent='Ôºã Industry';
      addIndBtn.onclick=()=>openModal('industry', domain);

      const editBtn=document.createElement('button'); editBtn.textContent='‚úé';
      editBtn.onclick=()=>openModal('edit', domain);

      const delBtn=document.createElement('button'); delBtn.textContent='üóë';
      delBtn.onclick=()=>{ if(confirm('Delete this domain?')) deleteDomain(domain); }

      actionsDiv.appendChild(addIndBtn); actionsDiv.appendChild(editBtn); actionsDiv.appendChild(delBtn);
      headerDiv.appendChild(actionsDiv);
    }

    domainDiv.appendChild(headerDiv);

    const industryGrid=document.createElement('div'); industryGrid.className='industry-grid';
    domain.industriesData.forEach(ind=>{
      const card=document.createElement('div'); card.className='industry-card';
      card.innerHTML=`<span>${ind.name}</span>`;
      if(isAdmin){
        const editI=document.createElement('button'); editI.textContent='‚úé';
        editI.onclick=()=>openModal('edit', domain, ind);
        const delI=document.createElement('button'); delI.textContent='üóë';
        delI.onclick=()=>{ if(confirm('Delete this industry?')) deleteIndustry(domain, ind); }
        card.appendChild(editI); card.appendChild(delI);
      }
      industryGrid.appendChild(card);
    });
    domainDiv.appendChild(industryGrid);
    domainsContainer.appendChild(domainDiv);
  });
  document.getElementById('add-domain').style.display=isAdmin?'inline-block':'none';
}

// Open Modal
function openModal(mode, domain=null, industry=null){
  if(!isAdmin) return;
  modal.classList.remove('hidden');
  nameInput.value='';
  parentSelect.innerHTML='';
  modalMode=mode;
  editTarget={domain, industry};

  if(mode==='domain'){
    document.getElementById('modal-title').textContent='Add Domain';
    parentLabel.style.display='none';
  }else if(mode==='industry'){
    document.getElementById('modal-title').textContent='Add Industry';
    parentLabel.style.display='block';
    const placeholder=document.createElement('option');
    placeholder.value=''; placeholder.textContent='-- Select Domain --';
    parentSelect.appendChild(placeholder);
    domainsData.forEach(d=>{
      const opt=document.createElement('option');
      opt.value=d.id; opt.textContent=d.name;
      if(domain && d.id===domain.id) opt.selected=true;
      parentSelect.appendChild(opt);
    });
  }else if(mode==='edit'){
    document.getElementById('modal-title').textContent='Edit';
    if(industry){
      nameInput.value=industry.name;
      parentLabel.style.display='block';
      const placeholder=document.createElement('option');
      placeholder.value=''; placeholder.textContent='-- Select Domain --';
      parentSelect.appendChild(placeholder);
      domainsData.forEach(d=>{
        const opt=document.createElement('option');
        opt.value=d.id; opt.textContent=d.name;
        if(d.id===domain.id) opt.selected=true;
        parentSelect.appendChild(opt);
      });
    }else{
      nameInput.value=domain.name;
      parentLabel.style.display='none';
    }
  }
  nameInput.focus();
}

function closeModal(){ modal.classList.add('hidden'); modalMode=null; editTarget=null; }
document.getElementById('cancel-btn').addEventListener('click', closeModal);

document.getElementById('save-btn').addEventListener('click', async ()=>{
  const val=nameInput.value.trim();
  if(!val) return alert('Enter a name!');

  try{
    if(modalMode==='domain'){
      if(editTarget.domain){
        await fetch(`http://localhost:5000/api/domains/${editTarget.domain.id}`,{
          method:'PATCH',
          headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+loggedInUser.token },
          body: JSON.stringify({ name: val })
        });
      }else{
        await fetch('http://localhost:5000/api/domains',{
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+loggedInUser.token },
          body: JSON.stringify({ name: val })
        });
      }
    }else if(modalMode==='industry'){
      const parentDomainId=parseInt(parentSelect.value);
      if(!parentDomainId) return alert('Please select a valid domain!');

      if(editTarget.industry){
        await fetch(`http://localhost:5000/api/industries/${editTarget.industry.id}`,{
          method:'PATCH',
          headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+loggedInUser.token },
          body: JSON.stringify({ name: val, domain_id: parentDomainId })
        });
      }else{
        await fetch(`http://localhost:5000/api/domains/${parentDomainId}/industries`,{
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+loggedInUser.token },
          body: JSON.stringify({ name: val })
        });
      }
    }
    await loadDomains();
    closeModal();
  }catch(err){ console.error(err); alert('Failed to save.'); }
});

async function deleteDomain(domain){
  try{
    await fetch(`http://localhost:5000/api/domains/${domain.id}`,{
      method:'DELETE',
      headers:{ 'Authorization':'Bearer '+loggedInUser.token }
    });
    await loadDomains();
  }catch(err){ console.error(err); alert('Failed to delete domain'); }
}

async function deleteIndustry(domain, industry){
  try{
    await fetch(`http://localhost:5000/api/industries/${industry.id}`,{
      method:'DELETE',
      headers:{ 'Authorization':'Bearer '+loggedInUser.token }
    });
    await loadDomains();
  }catch(err){ console.error(err); alert('Failed to delete industry'); }
}

document.getElementById('add-domain').addEventListener('click', ()=>openModal('domain'));

document.getElementById('theme-toggle').addEventListener('click', ()=>{
  document.body.classList.toggle('light');
  document.getElementById('theme-toggle').textContent=document.body.classList.contains('light')?'‚òÄÔ∏è':'üåô';
});

loadDomains();
</script>
</body>
</html>
